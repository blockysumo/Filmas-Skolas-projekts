<!DOCTYPE html>
<html>
<head>
    <title>Spotify Statistics</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Arial', sans-serif;
        }
        .plot-container {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: transform 0.2s;
        }
        .plot-container:hover {
            transform: translateY(-3px);
        }
        .plot-img {
            width: 100%;
            height: auto;
            max-height: 600px;
            object-fit: contain;
        }
        .metric-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin: 10px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .spotify-green {
            color: #1DB954;
            font-weight: bold;
        }
        .table-hover tbody tr:hover {
            background-color: rgba(29, 185, 84, 0.1);
        }
        thead {
            background-color: #1DB954;
            color: white;
        }
        .heatmap-labels {
            font-size: 0.9em;
            color: #666;
        }
        .sortable {
            cursor: pointer;
            position: relative;
        }
        .sortable::after {
            content: "â†•";
            margin-left: 5px;
            font-size: 0.8em;
            color: rgba(255, 255, 255, 0.5);
        }
        .sortable.asc::after {
            content: "â†‘";
            color: white;
        }
        .sortable.desc::after {
            content: "â†“";
            color: white;
        }
    </style>
</head>
<body class="bg-light">
    <div class="container py-5">
        <h1 class="text-center mb-5 spotify-green">ðŸŽ§ Your Spotify Listening Analysis</h1>

        <!-- Summary Metrics -->
        <div class="row row-cols-1 row-cols-md-3 g-4 mb-5">
            <div class="col">
                <div class="metric-card text-center">
                    <h5>Total Listening Time</h5>
                    <h2 class="spotify-green">{{ metrics.total_listening }}</h2>
                </div>
            </div>
            <div class="col">
                <div class="metric-card text-center">
                    <h5>Rickroll Encounters</h5>
                    <h2 class="spotify-green">{{ metrics.rickroll_count }}</h2>
                    <small class="text-muted">Never gonna give you up!</small>
                </div>
            </div>
            <div class="col">
                <div class="metric-card text-center">
                    <h5>Total Tracks Played</h5>
                    <h2 class="spotify-green">{{ metrics.total_tracks }}</h2>
                    <small class="text-muted">{{ "%.1f"|format(metrics.total_tracks/365) }}/day</small>
                </div>
            </div>
        </div>

        <!-- Main Visualizations -->
        <div class="row g-4">
            <div class="col-md-6">
                <div class="plot-container">
                    <h3 class="mb-4">Yearly Listening Trends</h3>
                    <img src="{{ url_for('static', filename=plots.yearly_listening) }}" class="plot-img">
                </div>
            </div>

            <div class="col-md-6">
                <div class="plot-container">
                    <h3 class="mb-4">Daily Listening Rhythm</h3>
                    <img src="{{ url_for('static', filename=plots.hourly_activity) }}" class="plot-img">
                </div>
            </div>
        </div>

        <!-- Heatmap Section -->
        <div class="plot-container">
            <h3 class="mb-4">Weekly Listening Patterns</h3>
            <img src="{{ url_for('static', filename=plots.activity_heatmap) }}" class="plot-img">
            <div class="heatmap-labels text-center mt-3">
                <span class="me-3">ðŸ”µ More Listening</span>
                <span>ðŸŸ¢ Less Listening</span>
            </div>
        </div>

        <!-- Track Analysis Row -->
        <div class="row g-4">
            <div class="col-md-6">
                <div class="plot-container">
                    <h3 class="mb-4">Track Length Preferences</h3>
                    <img src="{{ url_for('static', filename=plots.duration_distribution) }}" class="plot-img">
                </div>
            </div>

            <div class="col-md-6">
                <div class="plot-container">
                    <h3 class="mb-4">Top 7 Skipped Tracks</h3>
                    <img src="{{ url_for('static', filename=plots.skipped_songs) }}" class="plot-img">
                </div>
            </div>
        </div>

        <!-- Top Tracks Table -->
        <div class="plot-container">
            <h3 class="mb-4">Most Played Tracks</h3>
            <div class="table-responsive">
                <table class="table table-hover align-middle">
                    <thead>
                        <tr>
                            <th class="sortable" onclick="sortTable(0, false)">Track</th>
                            <th class="sortable" onclick="sortTable(1, false)">Artist</th>
                            <th class="sortable" onclick="sortTable(2)">Plays</th>
                            <th class="sortable" onclick="sortTable(3)">Total Time</th>
                            <th class="sortable" onclick="sortSkipRate(4)">Skip Rate</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for track in metrics.top_tracks %}
                        <tr>
                            <td class="fw-bold">{{ track.master_metadata_track_name }}</td>
                            <td>{{ track.artist }}</td>
                            <td>{{ track.plays }}</td>
                            <td data-ms="{{ track.total_ms }}">{{ track.total_time }}</td>
                            <td>
                                <span class="badge {% if track.skip_rate > 0.5 %}bg-danger{% else %}bg-warning{% endif %}">
                                    {{ "%.0f"|format(track.skip_rate*100) }}%
                                </span>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Artist Timeline -->
        {% if plots.artist_timeline %}
        <div class="plot-container">
            <h3 class="mb-4">{{ metrics.top_artist }} Listening Journey</h3>
            <img src="{{ url_for('static', filename=plots.artist_timeline) }}" class="plot-img">
        </div>
        {% endif %}

        <!-- Top Artists -->
        <div class="plot-container">
            <h3 class="mb-4">Artist Loyalty</h3>
            <img src="{{ url_for('static', filename=plots.top_artists) }}" class="plot-img">
        </div>

        <!-- Export Button -->
        <div class="text-center mt-4">
            <a href="{{ url_for('export_data') }}" class="btn btn-success spotify-green">
                ðŸ“¤ Export Full Data Package
            </a>
            <small class="d-block mt-2 text-muted">Includes all charts + CSV data</small>
        </div>

        <footer class="text-center mt-5 text-muted">
            <small>
                Generated on {{ current_year }} â€¢ 
                <a href="/" class="text-decoration-none spotify-green">Analyze another file</a>
            </small>
        </footer>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            updateVisibleRows();
        });
    
        function updateVisibleRows() {
            const rows = document.querySelectorAll('.table-hover tbody tr');
            rows.forEach((row, index) => {
                row.style.display = index < 10 ? '' : 'none';
            });
        }
    
        function sortTable(columnIndex, isNumeric = false) {
            const table = document.querySelector('.table-hover');
            const tbody = table.querySelector('tbody');
            const rows = Array.from(tbody.querySelectorAll('tr'));
            const header = table.querySelectorAll('th')[columnIndex];
            
            // Toggle sorting direction
            const isAsc = !header.classList.contains('asc');
            header.classList.remove('asc', 'desc');
            header.classList.add(isAsc ? 'asc' : 'desc');
    
            rows.sort((a, b) => {
                const aVal = getSortValue(a, columnIndex);
                const bVal = getSortValue(b, columnIndex);
                
                if (columnIndex <= 1) { // Track and Artist columns
                    return isAsc ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
                }
                return isAsc ? aVal - bVal : bVal - aVal;
            });
    
            // Rebuild table
            rows.forEach(row => tbody.appendChild(row));
            updateVisibleRows();
        }
    
        function getSortValue(row, columnIndex) {
            const cell = row.children[columnIndex];
            switch(columnIndex) {
                case 0: // Track
                case 1: // Artist
                    return cell.textContent.trim().toLowerCase();
                
                case 3: // Total Time
                    return parseInt(cell.dataset.ms); // Use raw ms value
                    
                case 2: // Plays
                    return parseInt(cell.textContent);
                    
                default:
                    return 0;
            }
        }
    
        function sortSkipRate(columnIndex) {
            const table = document.querySelector('.table-hover');
            const tbody = table.querySelector('tbody');
            const rows = Array.from(tbody.querySelectorAll('tr'));
            const header = table.querySelectorAll('th')[columnIndex];
            
            const isAsc = !header.classList.contains('asc');
            header.classList.remove('asc', 'desc');
            header.classList.add(isAsc ? 'asc' : 'desc');
    
            rows.sort((a, b) => {
                const aRate = parseFloat(a.children[columnIndex].querySelector('.badge').textContent);
                const bRate = parseFloat(b.children[columnIndex].querySelector('.badge').textContent);
                return isAsc ? aRate - bRate : bRate - aRate;
            });
    
            rows.forEach(row => tbody.appendChild(row));
            updateVisibleRows();
        }
    </script>
</body>
</html>